<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte du Trajet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-extra-markers/dist/css/leaflet.extra-markers.min.css" />

  <style>
    #map {
      height: 80vh;
      width: 90%;
      margin: 20px auto;
      border-radius: 12px;
    }
    #instructions {
      text-align: center;
      margin: 10px auto;
      background: #eef;
      width: fit-content;
      padding: 8px 14px;
      border-radius: 8px;
      display: none;
    }
    #login {
      text-align: center;
      margin: 20px;
    }
    button {
      margin-top: 6px;
      padding: 6px 12px;
      border: none;
      background: #004080;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #0059b3; }
    .color-picker {
      display: none;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .color-option {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      border: 2px solid white;
      cursor: pointer;
      box-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    .color-option:hover { transform: scale(1.2); }

    /* üìç Coordonn√©es en bas √† gauche */
    #coords {
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 6px 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 14px;
      border-radius: 6px;
      z-index: 9999;
      display: none;
    }
  </style>
</head>
<body>

<header>
  <h1>Trajectoire du Porte-conteneurs</h1>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="carte.html">Carte</a>
  </nav>
</header>

<div id="instructions">
  üó∫Ô∏è Clique sur la carte pour ajouter un point.<br>
  üé® Choisis une couleur avant d‚Äôajouter un marqueur.<br>
  ‚úèÔ∏è Clique sur un point pour le modifier ou le supprimer.<br>
</div>

<div id="login">
  <input type="password" id="passwordInput" placeholder="Mot de passe admin">
  <button id="loginBtn">Connexion</button>
</div>

<div id="colorPalette" class="color-picker">
  <div class="color-option" style="background:red;" data-color="red"></div>
  <div class="color-option" style="background:orange;" data-color="orange"></div>
  <div class="color-option" style="background:green;" data-color="green"></div>
  <div class="color-option" style="background:blue;" data-color="blue"></div>
  <div class="color-option" style="background:purple;" data-color="purple"></div>
  <div class="color-option" style="background:black;" data-color="black"></div>
</div>

<div id="map"></div>
<div id="coords"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-extra-markers/dist/js/leaflet.extra-markers.min.js"></script>

<script>
/* üîê Mot de passe */
const ADMIN_PASSWORD = "conteneurs2025";

/* üîó URL Google Sheets */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbxpdytMtfg_A4OyOvZSSFXqBYklwCLei4uQJY_b69Cl2BFM7xmYAE-KdLUbxdkdZUoa/exec";

/* üó∫Ô∏è Leaflet */
let isAdmin = false;
let selectedColor = "blue";
let points = [];
let map = L.map("map").setView([0, 0], 2);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

/* üé® Ic√¥ne color√©e */
function coloredMarker(color) {
  return L.ExtraMarkers.icon({
    icon: "fa-ship",
    markerColor: color || "blue",
    shape: "circle",
    prefix: "fa"
  });
}

/* üñºÔ∏è Affichage des points */
function renderPoints() {
  map.eachLayer(layer => {
    if (layer instanceof L.Marker) map.removeLayer(layer);
  });

  points.forEach((p, i) => {
    const marker = L.marker([p.lat, p.lng], {
      icon: coloredMarker(p.color)
    }).addTo(map);

    marker.bindTooltip(
      p.shortInfo || "",
      { permanent: true, direction: "top", offset: [0, -10] }
    );

    let popup = `
      <b>${p.description}</b><br>
      <i>Lat: ${p.lat}, Lng: ${p.lng}</i>
    `;

    if (isAdmin) {
      popup += `
        <br><button onclick="editPoint(${i})">‚úèÔ∏è Modifier</button>
        <button onclick="deletePoint(${i})">üóëÔ∏è Supprimer</button>
      `;
    }

    marker.bindPopup(popup);
  });
}

/* üü¶ Google Sheets ‚Üí Points */
async function loadFromSheets() {
  try {
    const res = await fetch(SHEET_URL + "?read=1");
    const data = await res.json();
    if (data.length > 0) {
      points = data;
      localStorage.setItem("points", JSON.stringify(points));
      renderPoints();
      return true;
    }
  } catch (e) {
    console.log("Erreur lecture Sheets", e);
  }
  return false;
}

/* üüß LocalStorage ‚Üí Google Sheets (migration initiale) */
async function migrateLocalToSheets() {
  const local = JSON.parse(localStorage.getItem("points")) || [];
  if (local.length === 0) return;

  for (const p of local) {
    await fetch(SHEET_URL, {
      method: "POST",
      body: JSON.stringify(p)
    });
  }

  localStorage.removeItem("points");
}

/* üöÄ Chargement initial */
(async () => {
  const hasSheets = await loadFromSheets();

  if (!hasSheets) {
    await migrateLocalToSheets();
    await loadFromSheets();
  }

  renderPoints();
})();

/* ‚ûï Ajouter un point */
map.on("click", e => {
  if (!isAdmin) return;

  const lat = e.latlng.lat.toFixed(5);
  const lng = e.latlng.lng.toFixed(5);

  const shortInfo = prompt("Texte court (affich√© en permanence) :");
  if (!shortInfo) return;

  const description = prompt("Texte complet (affich√© au clic) :");
  if (!description) return;

  const newPoint = { lat, lng, shortInfo, description, color: selectedColor };
  points.push(newPoint);
  renderPoints();

  fetch(SHEET_URL, {
    method: "POST",
    body: JSON.stringify(newPoint)
  });
});

/* ‚úèÔ∏è Modifier */
window.editPoint = function(i) {
  const p = points[i];

  const newShort = prompt("Texte court :", p.shortInfo);
  if (!newShort) return;

  const newDesc = prompt("Texte complet :", p.description);
  if (!newDesc) return;

  p.shortInfo = newShort;
  p.description = newDesc;

  fetch(SHEET_URL, { method: "POST", body: JSON.stringify(p) });
  renderPoints();
};

/* üóëÔ∏è Supprimer */
window.deletePoint = function(i) {
  if (!confirm("Supprimer ce point ?")) return;

  points.splice(i, 1);
  renderPoints();

  fetch(SHEET_URL + "?delete=" + i);
};

/* üîê Connexion */
document.getElementById("loginBtn").addEventListener("click", () => {
  if (document.getElementById("passwordInput").value === ADMIN_PASSWORD) {
    isAdmin = true;
    alert("Connexion r√©ussie !");
    document.getElementById("login").style.display = "none";
    document.getElementById("instructions").style.display = "block";
    document.getElementById("colorPalette").style.display = "flex";
    renderPoints();
  } else {
    alert("Mot de passe incorrect ‚ùå");
  }
});

/* üé® S√©lecteur couleur */
document.querySelectorAll(".color-option").forEach(el => {
  el.addEventListener("click", () => {
    selectedColor = el.dataset.color;

    document.querySelectorAll(".color-option").forEach(c =>
      c.style.border = "2px solid white"
    );
    el.style.border = "3px solid black";
  });
});

/* üß≠ Coordonn√©es bas-gauche */
const coordsDiv = document.getElementById("coords");
map.on("mousemove", e => {
  coordsDiv.style.display = "block";
  coordsDiv.textContent =
    `Lat: ${e.latlng.lat.toFixed(5)} | Lng: ${e.latlng.lng.toFixed(5)}`;
});
map.on("mouseout", () => coordsDiv.style.display = "none");

</script>

</body>
</html>
